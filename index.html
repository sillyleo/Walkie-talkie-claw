<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="theme-color" content="#111111">
<link rel="manifest" href="manifest.json">
<title>Â∞çË¨õÊ©ü</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#111;color:#eee;height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-user-select:none;user-select:none}

.status-bar{padding:14px 16px;text-align:center;font-size:1.1em;font-weight:700;letter-spacing:3px;text-transform:uppercase}
.status-locked{background:#222;color:#666}
.status-chat{background:#1a2a1a;color:#4f4}
.status-command{background:#2a1a1a;color:#f44}
.status-waiting{background:#2a2a1a;color:#fc4}

/* Big circular button */
.big-btn{
  width:160px;height:160px;border-radius:50%;border:6px solid #2a2a2a;
  background:#22cc44;color:#fff;font-size:1.2em;font-weight:700;
  cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;touch-action:none;
  box-shadow:0 0 30px rgba(34,204,68,0.3);letter-spacing:1px;
}
.big-btn.recording{
  background:#dd2222;border-color:#ff4444;transform:scale(1.1);
  box-shadow:0 0 40px rgba(255,0,0,0.4);
  animation:pulse-red 1s infinite;
}
.big-btn.waiting{
  background:#ccaa00;border-color:#ffcc00;
  box-shadow:0 0 30px rgba(255,204,0,0.3);
  animation:pulse-yellow 1.5s infinite;pointer-events:none;
}
@keyframes pulse-red{0%,100%{box-shadow:0 0 20px rgba(255,0,0,0.4)}50%{box-shadow:0 0 50px rgba(255,0,0,0.2)}}
@keyframes pulse-yellow{0%,100%{box-shadow:0 0 20px rgba(255,204,0,0.3)}50%{box-shadow:0 0 40px rgba(255,204,0,0.1)}}

/* Lock screen */
#lock-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;padding:24px}
#lock-screen .title{font-size:1.8em;font-weight:700;color:#fff;letter-spacing:2px}
#lock-screen .hint{color:#888;font-size:1em;text-align:center;max-width:300px;line-height:1.7}
#lock-screen .transcript{color:#fff;font-size:1.4em;min-height:1.5em;text-align:center;font-weight:600}
.lock-form{display:flex;gap:12px;align-items:center}
.lock-form input{padding:14px 18px;border:2px solid #333;border-radius:14px;background:#1a1a1a;color:#fff;font-size:1.1em;width:220px;outline:none}
.lock-form input:focus{border-color:#22cc44}
.btn-unlock{padding:14px 28px;border:none;border-radius:14px;font-size:1.1em;font-weight:600;cursor:pointer;background:#22cc44;color:#fff}
.btn-unlock:active{background:#1a9a33}
.lock-error{color:#f44;font-size:0.95em;min-height:1.4em}

/* Chat screen */
#chat-screen{flex:1;display:none;flex-direction:column;height:100dvh;overflow:hidden}
#messages{flex:1;min-height:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:85%;padding:12px 16px;border-radius:18px;font-size:1em;line-height:1.6;word-break:break-word}
.msg-user{align-self:flex-end;background:#2a2a4a;border-bottom-right-radius:4px}
.msg-bot{align-self:flex-start;background:#2a2a2a;border-bottom-left-radius:4px}
.msg-bot .play-btn{background:none;border:none;color:#666;cursor:pointer;font-size:1em;margin-left:8px}
.msg-bot .play-btn:hover{color:#fff}

/* PTT area */
#ptt-area{flex-shrink:0;padding:24px;display:flex;flex-direction:column;align-items:center;gap:14px;background:#0a0a0a}
#transcript-live{color:#888;font-size:0.9em;min-height:1.4em;text-align:center}
#mode-label{font-size:0.85em;color:#555;letter-spacing:1px}

.typing{color:#666;font-style:italic}
</style>
</head>
<body>

<!-- status bar removed -->

<div id="lock-screen">
  <div class="title">Â∞çË¨õÊ©ü</div>
  <div class="hint" id="lock-hint">ËºâÂÖ•‰∏≠...</div>
  <div class="lock-form">
    <input type="password" id="passphrase-input" placeholder="Ëº∏ÂÖ•ÈÄöÈóúÂØÜË™û" autocomplete="off">
    <button class="btn-unlock" id="btn-unlock">Ëß£Èéñ</button>
  </div>
  <div class="lock-error" id="lock-error"></div>
</div>

<div id="chat-screen">
  <div id="messages"></div>
  <div id="ptt-area">
    <div id="transcript-live">&nbsp;</div>
    <button class="big-btn" id="ptt-btn">Êåâ‰ΩèË™™Ë©±</button>
    <!-- mode label removed -->
    <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
      <button id="tts-toggle" style="background:none;border:1px solid #333;color:#666;padding:6px 14px;border-radius:8px;font-size:0.8em;cursor:pointer" onclick="ttsEnabled=!ttsEnabled;localStorage.setItem('wt_tts',ttsEnabled?'1':'0');this.textContent=ttsEnabled?'üîä Ë™ûÈü≥Èñã':'üîá Ë™ûÈü≥Èóú';this.style.color=ttsEnabled?'#4f4':'#666'">üîá Ë™ûÈü≥Èóú</button>
      <button id="voice-settings-btn" style="background:none;border:1px solid #333;color:#666;padding:6px 14px;border-radius:8px;font-size:0.8em;cursor:pointer" onclick="toggleVoiceSettings()">‚öôÔ∏è Ë™ûÈü≥Ë®≠ÂÆö</button>
    </div>
    <div id="voice-settings" style="display:none;background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:14px;margin-top:8px;width:100%;max-width:320px">
      <div style="margin-bottom:10px">
        <label style="font-size:0.8em;color:#888;display:block;margin-bottom:4px">Ë™ûÈü≥Ê®°Âûã</label>
        <select id="tts-model" style="width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#222;color:#eee;font-size:0.9em" onchange="saveTTSSettings()">
          <option value="openai/tts-1">OpenAI TTS-1</option>
          <option value="openai/tts-1-hd">OpenAI TTS-1-HD</option>
          <option value="gemini/gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
      </div>
      <div id="voice-select-wrap">
        <label style="font-size:0.8em;color:#888;display:block;margin-bottom:4px">ËÅ≤Èü≥</label>
        <select id="tts-voice" style="width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#222;color:#eee;font-size:0.9em" onchange="saveTTSSettings()">
          <option value="alloy">Alloy</option>
          <option value="echo">Echo</option>
          <option value="fable">Fable</option>
          <option value="onyx">Onyx</option>
          <option value="nova">Nova</option>
          <option value="shimmer" selected>Shimmer</option>
        </select>
      </div>
    </div>
  </div>
</div>

<script>
const API = location.origin;
let token = localStorage.getItem('wt_token');
let tokenTime = parseInt(localStorage.getItem('wt_token_time') || '0');
let isSetup = false;
let isRecording = false;

const $ = id => document.getElementById(id);
const statusBar = { className:'', textContent:'' }; // removed
const lockScreen = $('lock-screen');
const chatScreen = $('chat-screen');
const lockHint = $('lock-hint');
const lockError = $('lock-error');
const passphraseInput = $('passphrase-input');
const btnUnlock = $('btn-unlock');
const messages = $('messages');
const pttBtn = $('ptt-btn');
const transcriptLive = $('transcript-live');
// mode label removed

let ttsEnabled = localStorage.getItem('wt_tts') === '1';
let ttsAudio = null;
let ttsModel = localStorage.getItem('wt_tts_model') || 'openai/tts-1';
let ttsVoice = localStorage.getItem('wt_tts_voice') || 'shimmer';

function speak(text) {
  if (!ttsEnabled) return;
  playTTS(text);
}
async function playTTS(text) {
  if (ttsAudio) { ttsAudio.pause(); ttsAudio = null; }
  try {
    const r = await fetch(API + '/api/tts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, model: ttsModel, voice: ttsVoice })
    });
    if (!r.ok) return;
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    ttsAudio = new Audio(url);
    ttsAudio.play();
  } catch {}
}
function toggleVoiceSettings() {
  const el = $('voice-settings');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
function saveTTSSettings() {
  ttsModel = $('tts-model').value;
  ttsVoice = $('tts-voice').value;
  localStorage.setItem('wt_tts_model', ttsModel);
  localStorage.setItem('wt_tts_voice', ttsVoice);
  // Hide voice selector for Gemini (uses its own voices)
  const isGemini = ttsModel.startsWith('gemini/');
  $('voice-select-wrap').style.display = isGemini ? 'none' : 'block';
}
function initTTSSettings() {
  $('tts-model').value = ttsModel;
  $('tts-voice').value = ttsVoice;
  const isGemini = ttsModel.startsWith('gemini/');
  $('voice-select-wrap').style.display = isGemini ? 'none' : 'block';
  // Init TTS toggle button
  const ttsBtn = $('tts-toggle');
  if (ttsEnabled) { ttsBtn.textContent = 'üîä Ë™ûÈü≥Èñã'; ttsBtn.style.color = '#4f4'; }
}

function isSessionValid() {
  return token && (Date.now() - tokenTime < 4 * 60 * 60 * 1000);
}

async function api(path, body) {
  const r = await fetch(API + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return r.json();
}

function setBtnState(btn, state) {
  btn.classList.remove('recording', 'waiting');
  if (state === 'recording') {
    btn.classList.add('recording');
    btn.textContent = 'ËÅÜËÅΩ‰∏≠...';
  } else if (state === 'waiting') {
    btn.classList.add('waiting');
    btn.textContent = 'ËôïÁêÜ‰∏≠...';
  } else {
    btn.textContent = 'Êåâ‰ΩèË™™Ë©±';
  }
}

// --- LOCK SCREEN ---
async function initLock() {
  if (isSessionValid()) { enterChat(); return; }
  token = null;
  localStorage.removeItem('wt_token');

  try {
    const { hasPassphrase } = await (await fetch(API + '/api/status')).json();
    isSetup = !hasPassphrase;
  } catch(e) {
    lockHint.textContent = 'ÁÑ°Ê≥ïÈÄ£Á∑ö‰º∫ÊúçÂô®';
    return;
  }

  if (isSetup) {
    lockHint.textContent = 'È¶ñÊ¨°‰ΩøÁî®ÔºåË´ãË®≠ÂÆöÈÄöÈóúÂØÜË™û';
    btnUnlock.textContent = 'Ë®≠ÂÆö';
  } else {
    lockHint.textContent = 'Ëº∏ÂÖ•ÈÄöÈóúÂØÜË™ûËß£Èéñ';
  }

  btnUnlock.onclick = submitPassphrase;
  passphraseInput.addEventListener('keydown', e => { if (e.key === 'Enter') submitPassphrase(); });
}

async function submitPassphrase() {
  const text = passphraseInput.value.trim();
  if (!text) return;
  lockError.textContent = '';
  btnUnlock.disabled = true;
  btnUnlock.textContent = 'ËôïÁêÜ‰∏≠...';

  try {
    if (isSetup) {
      const res = await api('/api/setup-passphrase', { passphrase: text });
      if (res.ok) {
        token = res.token;
        localStorage.setItem('wt_token', token);
        localStorage.setItem('wt_token_time', '' + Date.now());
        if (res.hash) localStorage.setItem('wt_setup_hash', res.hash);
        enterChat();
      } else {
        lockError.textContent = res.error || 'Ë®≠ÂÆöÂ§±Êïó';
      }
    } else {
      const res = await api('/api/unlock', { passphrase: text });
      if (res.ok) {
        token = res.token;
        localStorage.setItem('wt_token', token);
        localStorage.setItem('wt_token_time', '' + Date.now());
        enterChat();
      } else {
        lockError.textContent = 'ÂØÜË™ûÈåØË™§ÔºåÂÜçË©¶‰∏ÄÊ¨°';
        passphraseInput.value = '';
        passphraseInput.focus();
      }
    }
  } catch(e) {
    lockError.textContent = 'ÈÄ£Á∑öÂ§±Êïó';
  }

  btnUnlock.disabled = false;
  btnUnlock.textContent = isSetup ? 'Ë®≠ÂÆö' : 'Ëß£Èéñ';
}

// --- CHAT SCREEN ---
function enterChat() {
  lockScreen.style.display = 'none';
  chatScreen.style.display = 'flex';
  statusBar.className = 'status-bar status-chat';
  statusBar.textContent = 'Â∞çË¨õÊ©ü';
  setupPTT(pttBtn, onChatResult, onChatEnd);
}

function onChatResult(text) {
  transcriptLive.textContent = text || '';
}

async function onChatEnd(text) {
  transcriptLive.textContent = '';
  if (!text) return;

  addMessage(text, 'user');
  const typing = addMessage('...', 'bot typing');
  setBtnState(pttBtn, 'waiting');
  statusBar.className = 'status-bar status-waiting';
  statusBar.textContent = 'Á≠âÂæÖÂõûË¶Ü...';

  const res = await api('/api/chat', { text, token });

  setBtnState(pttBtn, 'idle');
  statusBar.className = 'status-bar status-chat';
  statusBar.textContent = 'ËÅäÂ§©Ê®°Âºè';

  if (res.error === 'Ë´ãÈáçÊñ∞Ëß£Èéñ') {
    token = null;
    localStorage.removeItem('wt_token');
    location.reload();
    return;
  }

  typing.remove();
  const reply = res.reply || res.error || 'ÔºàÁÑ°ÂõûÊáâÔºâ';
  addMessage(reply, 'bot');
  speak(reply);
}

function addMessage(text, type) {
  const div = document.createElement('div');
  div.className = 'msg msg-' + type.split(' ')[0];
  if (type.includes('typing')) div.classList.add('typing');
  div.textContent = text;
  if (type === 'bot' && !type.includes('typing')) {
    const btn = document.createElement('button');
    btn.className = 'play-btn';
    btn.textContent = '‚ñ∂';
    btn.onclick = () => playTTS(text);
    div.appendChild(btn);
  }
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

// --- PTT (Whisper) ---
function setupPTT(btn, onResult, onEnd) {
  let mediaRec = null;
  let chunks = [];
  let stream = null;

  async function start(e) {
    e.preventDefault();
    if (isRecording) return;
    isRecording = true;
    chunks = [];
    setBtnState(btn, 'recording');
    onResult('üé§ ÈåÑÈü≥‰∏≠...');

    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRec = new MediaRecorder(stream, { mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm' });
      mediaRec.ondataavailable = e2 => { if (e2.data.size > 0) chunks.push(e2.data); };
      mediaRec.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());
        if (chunks.length === 0) { onEnd(''); return; }
        const blob = new Blob(chunks, { type: mediaRec.mimeType || 'audio/webm' });
        onResult('Ëæ®Ë≠ò‰∏≠...');
        setBtnState(btn, 'waiting');
        try {
          const r = await fetch(API + '/api/transcribe', {
            method: 'POST',
            headers: { 'Content-Type': blob.type },
            body: blob
          });
          const data = await r.json();
          const text = (data.text || '').trim();
          onResult(text || '');
          setBtnState(btn, 'idle');
          onEnd(text);
        } catch (err) {
          onResult('Ëæ®Ë≠òÂ§±Êïó');
          setBtnState(btn, 'idle');
          onEnd('');
        }
      };
      mediaRec.start();
    } catch (err) {
      onResult('ÁÑ°Ê≥ï‰ΩøÁî®È∫•ÂÖãÈ¢®');
      isRecording = false;
      setBtnState(btn, 'idle');
    }
  }

  function stop(e) {
    if (e) e.preventDefault();
    if (!isRecording) return;
    isRecording = false;
    if (mediaRec && mediaRec.state !== 'inactive') {
      mediaRec.stop();
    } else {
      setBtnState(btn, 'idle');
    }
  }

  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchstart', start, { passive: false });
  btn.addEventListener('touchend', stop, { passive: false });
  btn.addEventListener('touchcancel', stop);
}

initTTSSettings();
initLock();
</script>
</body>
</html>
