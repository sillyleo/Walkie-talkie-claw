<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="theme-color" content="#111111">
<link rel="manifest" href="manifest.json">
<title>對講機</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#111;color:#eee;height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-user-select:none;user-select:none}

.status-bar{padding:14px 16px;text-align:center;font-size:1.1em;font-weight:700;letter-spacing:3px;text-transform:uppercase}
.status-locked{background:#222;color:#666}
.status-chat{background:#1a2a1a;color:#4f4}
.status-command{background:#2a1a1a;color:#f44}
.status-waiting{background:#2a2a1a;color:#fc4}

/* Big circular button */
.big-btn{
  width:160px;height:160px;border-radius:50%;border:6px solid #2a2a2a;
  background:#22cc44;color:#fff;font-size:1.2em;font-weight:700;
  cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;touch-action:none;
  box-shadow:0 0 30px rgba(34,204,68,0.3);letter-spacing:1px;
}
.big-btn.recording{
  background:#dd2222;border-color:#ff4444;transform:scale(1.1);
  box-shadow:0 0 40px rgba(255,0,0,0.4);
  animation:pulse-red 1s infinite;
}
.big-btn.waiting{
  background:#ccaa00;border-color:#ffcc00;
  box-shadow:0 0 30px rgba(255,204,0,0.3);
  animation:pulse-yellow 1.5s infinite;pointer-events:none;
}
@keyframes pulse-red{0%,100%{box-shadow:0 0 20px rgba(255,0,0,0.4)}50%{box-shadow:0 0 50px rgba(255,0,0,0.2)}}
@keyframes pulse-yellow{0%,100%{box-shadow:0 0 20px rgba(255,204,0,0.3)}50%{box-shadow:0 0 40px rgba(255,204,0,0.1)}}

/* Lock screen */
#lock-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;padding:24px}
#lock-screen .title{font-size:1.8em;font-weight:700;color:#fff;letter-spacing:2px}
#lock-screen .hint{color:#888;font-size:1em;text-align:center;max-width:300px;line-height:1.7}
#lock-screen .transcript{color:#fff;font-size:1.4em;min-height:1.5em;text-align:center;font-weight:600}
.confirm-row{display:flex;gap:16px}
.confirm-row button{padding:14px 36px;border:none;border-radius:14px;font-size:1.1em;font-weight:600;cursor:pointer}
.btn-confirm{background:#22cc44;color:#fff}
.btn-cancel{background:#333;color:#aaa}

/* Chat screen */
#chat-screen{flex:1;display:none;flex-direction:column}
#messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:85%;padding:12px 16px;border-radius:18px;font-size:1em;line-height:1.6;word-break:break-word}
.msg-user{align-self:flex-end;background:#2a2a4a;border-bottom-right-radius:4px}
.msg-bot{align-self:flex-start;background:#2a2a2a;border-bottom-left-radius:4px}
.msg-bot .play-btn{background:none;border:none;color:#666;cursor:pointer;font-size:1em;margin-left:8px}
.msg-bot .play-btn:hover{color:#fff}

/* PTT area */
#ptt-area{padding:24px;display:flex;flex-direction:column;align-items:center;gap:14px;background:#0a0a0a}
#transcript-live{color:#888;font-size:0.9em;min-height:1.4em;text-align:center}
#mode-label{font-size:0.85em;color:#555;letter-spacing:1px}

.typing{color:#666;font-style:italic}
</style>
</head>
<body>

<div class="status-bar status-locked" id="status-bar">已鎖定</div>

<div id="lock-screen">
  <div class="title">對講機</div>
  <div class="hint" id="lock-hint">載入中...</div>
  <div class="transcript" id="lock-transcript"></div>
  <button class="big-btn" id="lock-ptt">按住說話</button>
  <div class="confirm-row" id="confirm-row" style="display:none">
    <button class="btn-confirm" id="btn-yes">確認</button>
    <button class="btn-cancel" id="btn-no">重來</button>
  </div>
</div>

<div id="chat-screen">
  <div id="messages"></div>
  <div id="ptt-area">
    <div id="transcript-live">&nbsp;</div>
    <button class="big-btn" id="ptt-btn">按住說話</button>
    <div id="mode-label">聊天模式</div>
  </div>
</div>

<script>
const API = location.origin;
let token = localStorage.getItem('wt_token');
let tokenTime = parseInt(localStorage.getItem('wt_token_time') || '0');
let isSetup = false;
let commandMode = false;
let commandTimer = null;
let isRecording = false;
let pendingPassphrase = null;

const $ = id => document.getElementById(id);
const statusBar = $('status-bar');
const lockScreen = $('lock-screen');
const chatScreen = $('chat-screen');
const lockHint = $('lock-hint');
const lockTranscript = $('lock-transcript');
const confirmRow = $('confirm-row');
const lockPtt = $('lock-ptt');
const messages = $('messages');
const pttBtn = $('ptt-btn');
const transcriptLive = $('transcript-live');
const modeLabel = $('mode-label');

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-TW';
  u.rate = 1.1;
  speechSynthesis.speak(u);
}

function isSessionValid() {
  return token && (Date.now() - tokenTime < 4 * 60 * 60 * 1000);
}

async function api(path, body) {
  const r = await fetch(API + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return r.json();
}

function setBtnState(btn, state) {
  btn.classList.remove('recording', 'waiting');
  if (state === 'recording') {
    btn.classList.add('recording');
    btn.textContent = '聆聽中...';
  } else if (state === 'waiting') {
    btn.classList.add('waiting');
    btn.textContent = '處理中...';
  } else {
    btn.textContent = '按住說話';
  }
}

// --- LOCK SCREEN ---
async function initLock() {
  if (isSessionValid()) { enterChat(); return; }
  token = null;
  localStorage.removeItem('wt_token');

  try {
    const { hasPassphrase } = await (await fetch(API + '/api/status')).json();
    isSetup = !hasPassphrase;
  } catch(e) {
    lockHint.textContent = '無法連線伺服器';
    return;
  }

  if (isSetup) {
    lockHint.textContent = '首次使用，請設定你的通關密語。\n長按按鈕說出密語。';
    speak('請說出你的通關密語');
  } else {
    lockHint.textContent = '長按按鈕說出通關密語解鎖';
    speak('請說出通關密語');
  }

  setupPTT(lockPtt, onLockResult, onLockEnd);
}

function onLockResult(text) {
  lockTranscript.textContent = text;
}

function onLockEnd(text) {
  if (!text) return;
  if (isSetup) {
    pendingPassphrase = text;
    lockHint.textContent = '你的密語是：';
    lockTranscript.textContent = text;
    confirmRow.style.display = 'flex';
  } else {
    tryUnlock(text);
  }
}

$('btn-yes').onclick = async () => {
  if (!pendingPassphrase) return;
  confirmRow.style.display = 'none';
  lockHint.textContent = '設定中...';
  setBtnState(lockPtt, 'waiting');
  const res = await api('/api/setup-passphrase', { passphrase: pendingPassphrase });
  setBtnState(lockPtt, 'idle');
  if (res.ok) {
    token = res.token;
    localStorage.setItem('wt_token', token);
    localStorage.setItem('wt_token_time', '' + Date.now());
    if (res.hash) localStorage.setItem('wt_setup_hash', res.hash);
    speak('設定完成');
    enterChat();
  } else {
    lockHint.textContent = res.error || '設定失敗';
    speak(res.error || '設定失敗');
  }
  pendingPassphrase = null;
};

$('btn-no').onclick = () => {
  pendingPassphrase = null;
  confirmRow.style.display = 'none';
  lockTranscript.textContent = '';
  lockHint.textContent = '再試一次，長按按鈕說出密語。';
};

async function tryUnlock(text) {
  lockHint.textContent = '驗證中...';
  setBtnState(lockPtt, 'waiting');
  const res = await api('/api/unlock', { passphrase: text });
  setBtnState(lockPtt, 'idle');
  if (res.ok) {
    token = res.token;
    localStorage.setItem('wt_token', token);
    localStorage.setItem('wt_token_time', '' + Date.now());
    speak('解鎖成功');
    enterChat();
  } else {
    lockHint.textContent = '密語錯誤，再試一次';
    lockTranscript.textContent = '';
    speak('密語錯誤');
  }
}

// --- CHAT SCREEN ---
function enterChat() {
  lockScreen.style.display = 'none';
  chatScreen.style.display = 'flex';
  statusBar.className = 'status-bar status-chat';
  statusBar.textContent = '聊天模式';
  setMode(false);
  setupPTT(pttBtn, onChatResult, onChatEnd);
}

function setMode(cmd) {
  commandMode = cmd;
  if (cmd) {
    statusBar.className = 'status-bar status-command';
    statusBar.textContent = '指令模式';
    modeLabel.textContent = '指令模式 (30秒)';
    clearTimeout(commandTimer);
    commandTimer = setTimeout(() => setMode(false), 30000);
  } else {
    statusBar.className = 'status-bar status-chat';
    statusBar.textContent = '聊天模式';
    modeLabel.textContent = '聊天模式';
  }
}

function onChatResult(text) {
  transcriptLive.textContent = text || '';
}

async function onChatEnd(text) {
  transcriptLive.textContent = '';
  if (!text) return;

  const checkRes = await api('/api/unlock', { passphrase: text });
  if (checkRes.ok) {
    setMode(true);
    addMessage('已切換至指令模式 (30秒)', 'bot');
    speak('指令模式已啟動');
    return;
  }

  addMessage(text, 'user');
  const typing = addMessage('...', 'bot typing');
  setBtnState(pttBtn, 'waiting');
  statusBar.className = 'status-bar status-waiting';
  statusBar.textContent = '等待回覆...';

  const res = await api('/api/chat', { text, mode: commandMode ? 'command' : 'chat', token });

  setBtnState(pttBtn, 'idle');
  setMode(commandMode); // restore status bar

  if (res.error === '請重新解鎖') {
    token = null;
    localStorage.removeItem('wt_token');
    location.reload();
    return;
  }

  typing.remove();
  const reply = res.reply || res.error || '（無回應）';
  addMessage(reply, 'bot');
  speak(reply);
}

function addMessage(text, type) {
  const div = document.createElement('div');
  div.className = 'msg msg-' + type.split(' ')[0];
  if (type.includes('typing')) div.classList.add('typing');
  div.textContent = text;
  if (type === 'bot' && !type.includes('typing')) {
    const btn = document.createElement('button');
    btn.className = 'play-btn';
    btn.textContent = '▶';
    btn.onclick = () => speak(text);
    div.appendChild(btn);
  }
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

// --- PTT ---
function setupPTT(btn, onResult, onEnd) {
  let rec = null;
  let finalText = '';
  let lastText = '';

  function start(e) {
    e.preventDefault();
    if (isRecording) return;
    isRecording = true;
    finalText = '';
    lastText = '';
    setBtnState(btn, 'recording');

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert('不支援語音辨識'); return; }
    rec = new SR();
    rec.lang = 'zh-TW';
    rec.interimResults = true;
    rec.continuous = true;
    rec.onresult = e2 => {
      let f = '', interim = '';
      for (let i = 0; i < e2.results.length; i++) {
        if (e2.results[i].isFinal) f += e2.results[i][0].transcript;
        else interim += e2.results[i][0].transcript;
      }
      finalText = f;
      lastText = f || interim;
      onResult(lastText);
    };
    rec.onerror = () => {};
    rec.onend = () => { if (isRecording) stop(); };
    rec.start();
  }

  function stop(e) {
    if (e) e.preventDefault();
    if (!isRecording) return;
    isRecording = false;
    setBtnState(btn, 'idle');
    if (rec) { try { rec.stop(); } catch {} }
    setTimeout(() => {
      onEnd(finalText || lastText);
    }, 500);
  }

  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchstart', start, { passive: false });
  btn.addEventListener('touchend', stop, { passive: false });
  btn.addEventListener('touchcancel', stop);
}

initLock();
</script>
</body>
</html>
