<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="theme-color" content="#111111">
<link rel="manifest" href="manifest.json">
<title>Â∞çË¨õÊ©ü</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#111;color:#eee;height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-user-select:none;user-select:none}
.status-bar{padding:12px 16px;text-align:center;font-size:1.1em;font-weight:600;letter-spacing:2px}
.status-locked{background:#222;color:#888}
.status-chat{background:#3a1111;color:#ff4444}
.status-command{background:#113a11;color:#44ff44}

/* Lock screen */
#lock-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;padding:24px}
#lock-screen .icon{font-size:4em}
#lock-screen .hint{color:#888;font-size:0.95em;text-align:center;max-width:280px;line-height:1.6}
#lock-screen .transcript{color:#fff;font-size:1.2em;min-height:2em;text-align:center}
#lock-screen .confirm-row{display:flex;gap:12px}
#lock-screen .confirm-row button{padding:10px 28px;border:none;border-radius:12px;font-size:1em;cursor:pointer}
.btn-confirm{background:#44ff44;color:#111}
.btn-cancel{background:#333;color:#eee}

/* Chat screen */
#chat-screen{flex:1;display:none;flex-direction:column}
#messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:85%;padding:10px 14px;border-radius:16px;font-size:0.95em;line-height:1.5;word-break:break-word}
.msg-user{align-self:flex-end;background:#2a2a4a;border-bottom-right-radius:4px}
.msg-bot{align-self:flex-start;background:#2a2a2a;border-bottom-left-radius:4px}
.msg-bot .play-btn{background:none;border:none;color:#888;cursor:pointer;font-size:1.1em;margin-left:6px}
.msg-bot .play-btn:hover{color:#fff}

/* PTT area */
#ptt-area{padding:20px;display:flex;flex-direction:column;align-items:center;gap:10px;background:#0a0a0a}
#transcript-live{color:#888;font-size:0.85em;min-height:1.2em;text-align:center}
#ptt-btn{width:100px;height:100px;border-radius:50%;border:4px solid #333;background:#222;font-size:2.2em;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;touch-action:none}
#ptt-btn:active,#ptt-btn.active{transform:scale(1.12);border-color:#ff4444;background:#331111}
#ptt-btn.active{animation:pulse 1s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,68,68,0.4)}50%{box-shadow:0 0 0 20px rgba(255,68,68,0)}}
#ptt-btn.command-mode{border-color:#44ff44}
#ptt-btn.command-mode.active{border-color:#44ff44;background:#113311;animation-name:pulse-green}
@keyframes pulse-green{0%,100%{box-shadow:0 0 0 0 rgba(68,255,68,0.4)}50%{box-shadow:0 0 0 20px rgba(68,255,68,0)}}
#mode-label{font-size:0.8em;color:#666}

/* Loading */
.typing{color:#666;font-style:italic}
</style>
</head>
<body>

<div class="status-bar status-locked" id="status-bar">üîí Â∑≤ÈéñÂÆö</div>

<div id="lock-screen">
  <div class="icon">üéôÔ∏è</div>
  <div class="hint" id="lock-hint">ËºâÂÖ•‰∏≠...</div>
  <div class="transcript" id="lock-transcript"></div>
  <div class="confirm-row" id="confirm-row" style="display:none">
    <button class="btn-confirm" id="btn-yes">‚úì Á¢∫Ë™ç</button>
    <button class="btn-cancel" id="btn-no">‚úó Èáç‰æÜ</button>
  </div>
</div>

<div id="chat-screen">
  <div id="messages"></div>
  <div id="ptt-area">
    <div id="transcript-live">&nbsp;</div>
    <button id="ptt-btn">üé§</button>
    <div id="mode-label">üî¥ ËÅäÂ§©Ê®°Âºè</div>
  </div>
</div>

<script>
const API = 'https://64.176.48.181:3847' !== location.origin ? 'http://64.176.48.181:3847' : location.origin;
let token = localStorage.getItem('wt_token');
let tokenTime = parseInt(localStorage.getItem('wt_token_time') || '0');
let isSetup = false;
let commandMode = false;
let commandTimer = null;
let passphraseHash = null; // we don't store this client-side, server checks
let recognition = null;
let isRecording = false;
let pendingPassphrase = null;

const $ = id => document.getElementById(id);
const statusBar = $('status-bar');
const lockScreen = $('lock-screen');
const chatScreen = $('chat-screen');
const lockHint = $('lock-hint');
const lockTranscript = $('lock-transcript');
const confirmRow = $('confirm-row');
const messages = $('messages');
const pttBtn = $('ptt-btn');
const transcriptLive = $('transcript-live');
const modeLabel = $('mode-label');

// TTS via browser
function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-TW';
  u.rate = 1.1;
  speechSynthesis.speak(u);
}

// Speech recognition
function createRecognition(onResult, onEnd) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert('Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠ò'); return null; }
  const r = new SR();
  r.lang = 'zh-TW';
  r.interimResults = true;
  r.continuous = false;
  let finalText = '';
  let interimText = '';
  r.onresult = e => {
    finalText = '';
    interimText = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalText += e.results[i][0].transcript;
      else interimText += e.results[i][0].transcript;
    }
    onResult(finalText || interimText, !!finalText);
  };
  r.onend = () => onEnd(finalText);
  r.onerror = () => onEnd(finalText);
  return r;
}

// Check session validity
function isSessionValid() {
  return token && (Date.now() - tokenTime < 4 * 60 * 60 * 1000);
}

// API helpers
async function api(path, body) {
  const r = await fetch(API + path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return r.json();
}

// --- LOCK SCREEN ---
async function initLock() {
  if (isSessionValid()) { enterChat(); return; }
  token = null;
  localStorage.removeItem('wt_token');

  const { hasPassphrase } = await (await fetch(API + '/api/status')).json();
  isSetup = !hasPassphrase;

  if (isSetup) {
    lockHint.textContent = 'È¶ñÊ¨°‰ΩøÁî®ÔºåË´ãË®≠ÂÆö‰Ω†ÁöÑÈÄöÈóúÂØÜË™û„ÄÇ\nÈï∑Êåâ‰∏ãÊñπÊåâÈàïË™™Âá∫ÂØÜË™û„ÄÇ';
    speak('Ë´ãË™™Âá∫‰Ω†ÁöÑÈÄöÈóúÂØÜË™û');
  } else {
    lockHint.textContent = 'Èï∑ÊåâÊåâÈàïË™™Âá∫ÈÄöÈóúÂØÜË™û‰ª•Ëß£Èéñ„ÄÇ';
    speak('Ë´ãË™™Âá∫ÈÄöÈóúÂØÜË™û');
  }

  // Add a PTT button for lock screen
  if (!$('lock-ptt')) {
    const btn = document.createElement('button');
    btn.id = 'lock-ptt';
    btn.textContent = 'üé§';
    btn.style.cssText = 'width:80px;height:80px;border-radius:50%;border:3px solid #333;background:#222;font-size:1.8em;cursor:pointer;touch-action:none;-webkit-tap-highlight-color:transparent';
    lockScreen.insertBefore(btn, confirmRow);
    setupPTT(btn, onLockResult, onLockEnd);
  }
}

function onLockResult(text) {
  lockTranscript.textContent = text;
}

function onLockEnd(text) {
  if (!text) return;
  if (isSetup) {
    pendingPassphrase = text;
    lockHint.textContent = `‰Ω†ÁöÑÂØÜË™ûÊòØ„Äå${text}„ÄçÂóéÔºü`;
    confirmRow.style.display = 'flex';
  } else {
    tryUnlock(text);
  }
}

$('btn-yes').onclick = async () => {
  if (!pendingPassphrase) return;
  confirmRow.style.display = 'none';
  lockHint.textContent = 'Ë®≠ÂÆö‰∏≠...';
  const res = await api('/api/setup-passphrase', { passphrase: pendingPassphrase });
  if (res.ok) {
    token = res.token;
    localStorage.setItem('wt_token', token);
    localStorage.setItem('wt_token_time', '' + Date.now());
    speak('Ë®≠ÂÆöÂÆåÊàê');
    enterChat();
  } else {
    lockHint.textContent = res.error || 'Ë®≠ÂÆöÂ§±Êïó';
    speak(res.error || 'Ë®≠ÂÆöÂ§±Êïó');
  }
  pendingPassphrase = null;
};

$('btn-no').onclick = () => {
  pendingPassphrase = null;
  confirmRow.style.display = 'none';
  lockTranscript.textContent = '';
  lockHint.textContent = 'ÂÜçË©¶‰∏ÄÊ¨°ÔºåÈï∑ÊåâÊåâÈàïË™™Âá∫ÂØÜË™û„ÄÇ';
};

async function tryUnlock(text) {
  lockHint.textContent = 'È©óË≠â‰∏≠...';
  const res = await api('/api/unlock', { passphrase: text });
  if (res.ok) {
    token = res.token;
    localStorage.setItem('wt_token', token);
    localStorage.setItem('wt_token_time', '' + Date.now());
    speak('Ëß£ÈéñÊàêÂäü');
    enterChat();
  } else {
    lockHint.textContent = 'ÂØÜË™ûÈåØË™§ÔºåÂÜçË©¶‰∏ÄÊ¨°„ÄÇ';
    lockTranscript.textContent = '';
    speak('ÂØÜË™ûÈåØË™§');
  }
}

// --- CHAT SCREEN ---
function enterChat() {
  lockScreen.style.display = 'none';
  chatScreen.style.display = 'flex';
  setMode(false);
  setupPTT(pttBtn, onChatResult, onChatEnd);
}

function setMode(cmd) {
  commandMode = cmd;
  if (cmd) {
    statusBar.className = 'status-bar status-command';
    statusBar.textContent = 'üü¢ Êåá‰ª§Ê®°Âºè';
    modeLabel.textContent = 'üü¢ Êåá‰ª§Ê®°Âºè';
    pttBtn.classList.add('command-mode');
    clearTimeout(commandTimer);
    commandTimer = setTimeout(() => setMode(false), 30000);
  } else {
    statusBar.className = 'status-bar status-chat';
    statusBar.textContent = 'üî¥ ËÅäÂ§©Ê®°Âºè';
    modeLabel.textContent = 'üî¥ ËÅäÂ§©Ê®°Âºè';
    pttBtn.classList.remove('command-mode');
  }
}

function onChatResult(text) {
  transcriptLive.textContent = text || '';
}

async function onChatEnd(text) {
  transcriptLive.textContent = '';
  if (!text) return;

  // Check if passphrase spoken ‚Üí activate command mode
  // We send to server to check, but also just switch mode
  // Simple heuristic: if text contains certain trigger words
  // Actually, command mode activates when passphrase is said.
  // We'll try unlock endpoint to check if it matches passphrase
  const checkRes = await api('/api/unlock', { passphrase: text });
  if (checkRes.ok) {
    // It's the passphrase! Switch to command mode
    setMode(true);
    addMessage('ÔºàÂ∑≤ÂàáÊèõËá≥Êåá‰ª§Ê®°Âºè - 30ÁßíÔºâ', 'bot');
    speak('Êåá‰ª§Ê®°ÂºèÂ∑≤ÂïüÂãï');
    return;
  }

  addMessage(text, 'user');
  const typing = addMessage('...', 'bot typing');

  const res = await api('/api/chat', { text, mode: commandMode ? 'command' : 'chat', token });
  if (res.error === 'Ë´ãÈáçÊñ∞Ëß£Èéñ') {
    token = null;
    localStorage.removeItem('wt_token');
    location.reload();
    return;
  }

  typing.remove();
  const reply = res.reply || res.error || 'ÔºàÁÑ°ÂõûÊáâÔºâ';
  addMessage(reply, 'bot');
  speak(reply);
}

function addMessage(text, type) {
  const div = document.createElement('div');
  div.className = 'msg msg-' + type.split(' ')[0];
  if (type.includes('typing')) div.classList.add('typing');
  div.textContent = text;
  if (type === 'bot') {
    const btn = document.createElement('button');
    btn.className = 'play-btn';
    btn.textContent = 'üîä';
    btn.onclick = () => speak(text);
    div.appendChild(btn);
  }
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

// --- PTT SETUP ---
function setupPTT(btn, onResult, onEnd) {
  let rec = null;
  let finalText = '';

  function start(e) {
    e.preventDefault();
    if (isRecording) return;
    isRecording = true;
    finalText = '';
    btn.classList.add('active');

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert('‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠ò'); return; }
    rec = new SR();
    rec.lang = 'zh-TW';
    rec.interimResults = true;
    rec.continuous = true;
    rec.onresult = e2 => {
      let f = '', interim = '';
      for (let i = 0; i < e2.results.length; i++) {
        if (e2.results[i].isFinal) f += e2.results[i][0].transcript;
        else interim += e2.results[i][0].transcript;
      }
      finalText = f;
      onResult(f || interim);
    };
    rec.onerror = () => {};
    rec.onend = () => {
      if (isRecording) stop(); // auto-ended
    };
    rec.start();
  }

  function stop(e) {
    if (e) e.preventDefault();
    if (!isRecording) return;
    isRecording = false;
    btn.classList.remove('active');
    if (rec) { try { rec.stop(); } catch {} }
    onEnd(finalText);
  }

  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchstart', start, { passive: false });
  btn.addEventListener('touchend', stop, { passive: false });
  btn.addEventListener('touchcancel', stop);
}

// Init
initLock();
</script>
</body>
</html>
